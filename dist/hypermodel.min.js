//================================================================================
// [hypermodel]
// version: 1.0.7
// update: 2018.04.30
//================================================================================


!function(E){var O=[],R=0;E.fn.hypermodel=function(n,t){var i=this,e="init",s=E(window);E(document);"object"!=typeof n&&(e=n,n=t);var I={grad:1.75,time:{animate:300,frame:3e3,highlight:3e3},update:null,strokeSpeed:500,strokeColor:"rgba(192, 192, 192, .6)",strokeHighlightColor:"rgba(200, 206, 255, .6)",strokeHighlightDashColor:"rgba(178, 192, 255, 1)",strokeDashColor:"rgba(192, 192, 192, .95)",strokeWidth:1,strokeHighlightWidth:1,strokeDashWidth:1,strokeDashWeight:8,strokeDashMargin:6};E.extend(I,n);var P={t:20,r:10,b:20,l:10,d:.5,g:1},a=E(this).addClass("hypermodel-wrapper"),o=null,$=null,r=window.getSelection?window.getSelection():document.selection?document.selection:null,d=function(){l.apply(this,Array.prototype.slice.call(arguments))},l=function(){s.triggerHandler("resize.hypermodelHandler")},h=function(t){var e=E(this);a.disableSelection(),e.sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:d,out:l,containment:"body",tolerance:"pointer",dropOnEmpty:!0,axis:"y",scroll:!0,beforeStop:function(t,e){var i=E(this).children(":last");i.position().top<e.position.top+2*e.item.height()&&i.insertBefore(e.item)},start:function(t,e){e.placeholder.height(e.item.height()),e.item.data("sortable-idx",e.item.index())},update:function(t,e){"function"==typeof I.update&&I.update.apply(this,Array.prototype.slice.call(arguments))},stop:function(){i.hypermodel("repaint")}})};switch(e){case"init":return O=[],this.each(function(){a.css("position","relative").bind("click",function(t){r&&(r.empty?r.empty():r.removeAllRanges())}),a.find(".hypermodel-column .hypermodel-grid").bind("click",function(t){t.stopPropagation();E(this)}).find(".hypermodel-item").bind("click",function(t){t.stopPropagation();E(this)}),s.unbind("resize.hypermodelHandler init.hypermodelHandler").bind("resize.hypermodelHandler init.hypermodelHandler",function(S){try{var e=0;a.find(".hypermodel-column").each(function(){var t=E(this);e+=t.outerWidth(!0)}),a.find(".hypermodel-area").outerWidth(parseInt(e+1));var D=a.offset().top,z=a.offset().left,M=parseInt(a.css("padding-top").replace(/[^\d]+/,"")||0),j=parseInt(a.css("padding-left").replace(/[^\d]+/,"")||0),t=0,i=0;try{t=a.parent()[0].scrollWidth-2*j,i=a.parent()[0].scrollHeight-2*M}catch(t){return!1}"init"==S.type?(E(".hyper-model-canvas").remove(),($=Raphael(0,0,t,i)).canvas.setAttribute("class","hyper-model-canvas"),o=E($.canvas),E($.canvas).appendTo(a).css({left:0+j,top:0+M})):o.attr({width:t,height:i});var r=E('<style class="hyper-model-anim"></style>');E(".hyper-model-anim").remove(),E("head").append(r);var q="";a.find(".hypermodel-grid, .hypermodel-item").unbind("click.hypermodelHandler").bind("click.hypermodelHandler",function(t){t.stopPropagation();E(this)}).each(function(){var t=E(this);if(void 0===t.data("target")||""===t.data("target"))return!0;var e,i,r={t:t.offset().top+P.d-P.g+P.t-D-M,r:t.offset().left+t.outerWidth()+P.d-P.g-z-j,b:t.offset().top+t.outerHeight()+P.d-P.g-D-M,l:t.offset().left+P.d-P.g-z-j},a="",o=t.data("target").toString().split(","),n={x:0,y:0},s={x:0,y:0};for(var d in void 0!==t.attr("id")&&null!==t.attr("id")&&void 0!==(a=t.attr("id").replace(/.*model-[nc](\d+).*/,"$1"))&&""!==a&&(a=parseInt(a)),o){var l=E.trim(o[d]),h=a+"->"+l,p=t.data("highlight")?t.data("highlight").split(","):"";for(var c in p){var m=p[c];p[c]=a+"->"+m}var u=E("#model-n"+l).filter(":visible").not(".ui-sortable-helper");if(u.length<=0||u.is(":hidden")||u.hasClass("ui-sortable-helper")){for(var g in O[h])try{O[h][g].remove()}catch(t){console.log(t)}delete O[h]}else{var f={t:u.offset().top+P.d+P.t-D-M,r:u.offset().left+u.outerWidth()+P.d-z-j,b:u.offset().top+u.outerHeight()+P.d-D-M,l:u.offset().left+P.d-z-j};n.x=r.r,n.y=r.t,s.x=f.l,s.y=f.t;var y="",v=(e=n,i=s,Math.sqrt(Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2)));if(y+=" M "+r.r+" "+r.t,r.t!==f.t){var k=Math.abs(r.r-f.l)/(1*I.grad),b=Math.abs(r.t-f.t)/100;y+=" C "+(r.r+k)+" "+(r.t+b)+" "+(f.l-k)+" "+(f.t-b)+" "}else y+=" L ";if(y+=f.l+" "+f.t,q+="@keyframes keyframe-dash-i"+R+" {to {stroke-dashoffset: "+v+";}}@-webkit-keyframes keyframe-dash-i"+R+" {to {stroke-dashoffset: "+v+";}}","init"!==S.type){for(var A in O[h]){var H=O[h][g];H.animate({path:y},I.time.animate),-1!=E.inArray(h,p)?(H.node.setAttribute("stroke-width",I.strokeHighlightWidth),"0"===g?H.node.setAttribute("stroke",I.strokeHighlightColor):H.node.setAttribute("stroke",I.strokeHighlightDashColor)):"0"===g?(H.node.setAttribute("type","straight"),H.node.setAttribute("stroke-width",I.strokeWidth),H.node.setAttribute("stroke",I.strokeColor)):(H.node.setAttribute("type","dash"),H.node.setAttribute("stroke-width",I.strokeDashWidth),H.node.setAttribute("stroke",I.strokeDashColor))}try{O[h][1].node.setAttribute("style","animation: keyframe-dash-i"+R+" "+v/I.strokeSpeed*I.time.frame/100+"s linear infinite; -webkit-animation: keyframe-dash-i"+R+" "+v/500*30+"s linear infinite")}catch(t){}}if(void 0===O[h]){O[h]=[];var w=$.path(y);w.node.setAttribute("stroke-width",I.strokeWidth),w.node.setAttribute("stroke",I.strokeColor),w.node.setAttribute("match",h),O[h].push(w);var C=$.path(y);C.node.setAttribute("stroke-width",I.strokeDashWidth),C.node.setAttribute("stroke",I.strokeDashColor),C.node.setAttribute("stroke-dasharray",I.strokeDashWeight+", "+I.strokeDashMargin),C.node.setAttribute("class","anim-path"),C.node.setAttribute("style","animation: keyframe-dash-i"+R+" "+v/I.strokeSpeed*I.time.frame/100+"s linear infinite; webkit-animation: keyframe-dash-i"+R+" "+v/500*30+"s linear infinite"),C.node.setAttribute("match",h),O[h].push(C),-1!=E.inArray(h,p)&&(w.node.setAttribute("stroke-width",I.strokeHighlightWidth),C.node.setAttribute("stroke-width",I.strokeHighlightWidth),w.node.setAttribute("stroke",I.strokeHighlightColor),C.node.setAttribute("stroke",I.strokeHighlightDashColor));var W=t.data("modelview-m"),x=u.data("modelview-p");(W=void 0!==W?W.toString().split(","):[]).push(h),(x=void 0!==x?x.toString().split(","):[]).push(h),t.data("modelview-m",E.unique(W).join(",")),u.data("modelview-p",E.unique(x).join(","))}R++}}}),r.text(q)}catch(t){console.warn(t)}}).triggerHandler("init.hypermodelHandler"),void 0!==E.fn.sortable&&(a.find(".hypermodel-column").each(h),a.find(".hypermodel-body").each(function(){E(this).sortable({items:".hypermodel-item:not(.hypermodel-item-add)",change:d,out:l,containment:"parent",tolerance:"pointer",start:function(t,e){e.placeholder.height(e.item.height()),e.item.data("sortable-idx",e.item.index())},update:function(t,e){"function"==typeof I.update&&I.update.apply(this,Array.prototype.slice.call(arguments))}})}))});case"add":var p=0,c=1e3;return E('[id^="model-"]').each(function(){var t=E(this),e=parseInt(t.attr("id").replace(/[^\d]+/,""));t.hasClass("hypermodel-grid")?p<e&&(p=e):t.hasClass("hypermodel-item")&&c<e&&(c=e)}),p++,c++,s.triggerHandler("resize.hypermodelHandler"),this.each(function(){var t=E(this);void 0!==E.fn.sortable&&t.parent().sortable({items:".hypermodel-grid",handle:".hypermodel-header",change:d,out:l,containment:"parent",tolerance:"intersect",axis:"y",scroll:!0,dropOnEmpty:!0,start:function(t,e){e.placeholder.height(e.item.height()),e.item.data("sortable-idx",e.item.index())},update:function(t,e){"function"==typeof I.update&&I.update.apply(this,Array.prototype.slice.call(arguments))}}).disableSelection(),t.hasClass("hypermodel-grid")?(t.attr("id",(t.attr("id")?t.attr("id")+" ":"")+"model-n"+p),p++):t.hasClass("hypermodel-item")&&(t.attr("id",(t.attr("id")?t.attr("id")+" ":"")+"model-n"+c),c++)});case"connect":return this.each(function(){var i=E(this);n.each(function(){var t=E(this).attr("id").replace(/.*model-[nc](\d+).*/,"$1"),e=i.data("target");(e=null!=e&&""!==e?e.split(","):[]).push(t),i.data("target",e.join(","))}),s.triggerHandler("resize.hypermodelHandler")});case"highlight":return this.each(function(){var r=E(this),e=r.data("highlight")?r.data("highlight"):"",a=[];if(e=""===e?[]:e.split(","),void 0===n){var t=(r.data("target")?r.data("target"):"").toString().split(",");for(var i in t){var o=t[i];e.push(o),a.push(o)}}else n.each(function(){var t=E(this).attr("id").replace(/.*model-[nc](\d+).*/,"$1");""!==t&&(e.push(t),a.push(t))});r.data("highlight",E.unique(e).join(",")),s.triggerHandler("resize.hypermodelHandler"),setTimeout(function(){var t=r.data("highlight")?r.data("highlight"):"";for(var e in t=""===t?[]:t.split(","),a){var i=a[e];-1!=E.inArray(i,t)&&t.splice(E.inArray(i,t),1)}r.data("highlight",E.unique(t).join(",")),s.triggerHandler("resize.hypermodelHandler")},I.time.highlight)});case"repaint":return s.triggerHandler("resize.hypermodelHandler"),this;case"remove":return this.each(function(){var t=E(this),e=[],i=t.data("modelview-m"),r=t.data("modelview-p");for(var a in null!=i&&(i=i.toString().split(","),e=e.concat(i)),null!=r&&(r=r.toString().split(","),e=e.concat(r)),e){var o=e[a];for(var n in O[o])try{O[o][n].remove(),delete e[a]}catch(t){console.log(t)}delete O[o]}}),this.hypermodel("repaint")}}}(jQuery);